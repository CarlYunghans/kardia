// This component displays a chat and a way to add more text messages to the
// chat as well as view ones that have been sent.
$Version=2$
newchat_panel "widget/component-decl"
    {
    width=385; height=300;
    
    chat_id "widget/parameter" {type="integer"; deploy_to_client="yes";}
                
    Stop "widget/component-decl-action" {}
    Stop_cn "widget/connector" { event=Stop; target=chat_timer; action=CancelTimer;}

    Start "widget/component-decl-action" {}
    Start_cn "widget/connector" { event=Start; target=chat_timer; action=SetTimer; Time=1; }
    
    chat_timer "widget/timer"
	{
	msec=30000;
	auto_reset=0;
	auto_start=1;
	interval_cn "widget/connector" { target=chat_osrc; event=Expire; action=Refresh;}
	}

    header_chat_name "widget/hbox"
        {
        width=380; height=20; x=10; y=10;
        spacing=5;

        chat_title_osrc "widget/osrc"
            {
            sql=runserver("SELECT * FROM /apps/kardia/data/Kardia_DB/c_chat/rows WHERE :c_chat_id == " + :this:chat_id);
            autoquery=onload;
            
            chat_title_form "widget/form"
                {
                
                chat_title_field "widget/editbox"
                    {
                    width=80;
                    fieldname="c_title";
                    }
                    
                chat_title_dt_m "widget/variable" { fieldname="s_date_modified"; chat_title_dt_m_hints "widget/hints" { default=runclient(getdate()); style=alwaysdef; } }
                chat_title_us_m "widget/variable" { fieldname="s_modified_by"; chat_title_us_m_hints "widget/hints" { default=runclient(user_name()); style=alwaysdef; } }
                }
            }
           
        change_title_button "widget/textbutton"
            {
            width=80;
            text="Change Title";
            
            save_cn "widget/connector"
                {
                action="Save";
                event="Click";
                target=chat_title_form;
                }
            
            } 
            
        invite_osrc "widget/osrc"{
            sql =  "SELECT * FROM /apps/kardia/data/Kardia_DB/c_member/rows";
            baseobj = "/apps/kardia/data/Kardia_DB/c_member/rows";
            autoquery = onload;
        
            not_on_users_list "widget/dropdown"
                {
                width=130; 
                mode=dynamic_server;
                sql=runserver("SELECT
                                    :s:name,
                                    :s:name
                               FROM /sys/cx.sysinfo/users s
                               WHERE
                                    (SELECT
                                        *
                                    FROM
                                        /apps/kardia/data/Kardia_DB/c_member/rows member
                                    WHERE
                                        :member:c_chat_id == " + :this:chat_id + " and
                                        :member:s_username == :s:name)
                                    is null");
                }
                
            invite_button "widget/textbutton"
                {
                width=60; 
                text="Invite";
                
                add_invitation_cn "widget/connector"
                    {
                    event="Click";
                    action="Create";
                    target=invite_osrc;
                    event_confirm=runclient("asdfsadf");
                    
                    // Parameters
                    c_chat_id= runclient(:newchat_panel:chat_id);
                    s_username=runclient(:not_on_users_list:value);
                    s_date_created=runclient(getdate());
                    s_created_by=runclient(user_name());
                    s_date_modified=runclient(getdate());
                    s_modified_by=runclient(user_name());
                    c_status=runclient("I");
                    c_last_read_mesage_id=runclient(0);
                    c_chat_id=runclient(:newchat_panel:chat_id);
                    }
                }
            }
        
        }

    chat_osrc "widget/osrc"
	{
        sql=runserver("UPDATE /apps/kardia/data/Kardia_DB/c_chat/rows
                            SET :c_last_message_id = 
                                    (SELECT max(:c_message_id)
                                    FROM /apps/kardia/data/Kardia_DB/c_message/rows
                                    WHERE :c_chat_id == " + :this:chat_id + "),
                                :c_last_send = 
                                    (SELECT max(:s_date_modified)
                                    FROM /apps/kardia/data/Kardia_DB/c_message/rows
                                    WHERE :c_chat_id == " + :this:chat_id + ")
                            WHERE :c_chat_id == " + :this:chat_id + ";
        
                        UPDATE /apps/kardia/data/Kardia_DB/c_member/rows
                            SET :c_last_read_message_id =
                                (SELECT max(:c_message_id)
                                FROM /apps/kardia/data/Kardia_DB/c_message/rows
                                WHERE :c_chat_id == " + :this:chat_id + ")
                            WHERE :s_username == user_name() and :c_chat_id == " + :this:chat_id + ";
                        
                            SELECT hist = sum('[' + condition(datepart(year,:s_date_created) != datepart(year,getdate()) or datepart(month,:s_date_created) != datepart(month, getdate()) or datepart(day,:s_date_created) != datepart(day,getdate()),
                                                           '' + datepart(month,:s_date_created) + '/' + datepart(day,:s_date_created) +
                                                                condition(datepart(year,getdate()) != datepart(year,:s_date_created),
                                                                          '/' + datepart(year,:s_date_created),
                                                                          '') + ' ',
                                                            '') +
                                                condition(datepart(hour,:s_date_created) < 10,
                                                           '0',
                                                           '') +
                                                datepart(hour,:s_date_created) + ':' +
                                                 condition(datepart(minute,:s_date_created) < 10,
                                                           '0',
                                                           '') +
                                                 datepart(minute,:s_date_created) +
                                                 '] ' + :c_message + '\n') - '\n'
                            FROM /apps/kardia/data/Kardia_DB/c_message/rows
                            WHERE (:c_chat_id == " + :this:chat_id + ")
                        ");
	baseobj = "/apps/kardia/data/Kardia_DB/c_message/rows";
	readahead=10;
	replicasize=10;
	indicates_activity = no;
        autoquery=onload;

	created_cn1 "widget/connector" { target=chat_timer; event=Created; action=SetTimer; Time=1; event_confirm=runclient("chat_id: " + :newchat_panel:chat_id);}

	endquery_cn1 "widget/connector" { event=EndQuery; target=chat_timer; action=SetTimer; Time=30000;  }
	endquery_cn2 "widget/connector" { event=EndQuery; target=log; action=SetValue; Value=runclient(:chat_osrc:hist); ContentType = runclient('text/plain'); }
	endquery_cn3 "widget/connector" { event=EndQuery; target=log; action=ShowText; }
	endquery_cn4 "widget/connector" { event=EndQuery; target=log_scroll; action=ScrollTo; Percent=100; }
	}

    log_pane "widget/pane"
	{
	x=10;y=40;width=380;height=210;
	style=lowered;
	bgcolor=white;

	log_scroll "widget/scrollpane"
	    {
	    x=0;y=0;width=380;height=210;

	    log "widget/html"
		{
		x=0;y=0;width=20;
		mode=dynamic;
		}
                
	    }
	}
        
    new_message_osrc "widget/osrc"
        {
        sql="SELECT * from /apps/kardia/data/Kardia_DB/c_message/rows";
        baseobj="/apps/kardia/data/Kardia_DB/c_message/rows";
        }

    type_eb "widget/editbox"
    	{
    	x=10;y=260;height=20;width=350;
    	enter_cn_1 "widget/connector" { target=chat_timer; event=ReturnPressed; action=CancelTimer; }
    	
        // Connector for the actual event - Same as send_cn_3 of send_button
        enter_cn_2 "widget/connector"
            {
            target=new_message_osrc;
            action="Create";
            event="ReturnPressed";
            //event_condition=runclient(not (rtrim(ltrim(:type_eb:content)) == ""));
            
            // Parameters
            c_chat_id=runclient(:newchat_panel:chat_id);
            c_message=runclient(:type_eb:content);
            s_date_created=runclient(getdate());
            s_created_by=runclient(user_name());
            s_date_modified=runclient(getdate());
            s_modified_by=runclient(user_name());
            }
            
        enter_cn_3 "widget/connector" { target=type_eb; event=ReturnPressed; action=SetValue; Value=runclient(''); }
        enter_cn_4 "widget/connector" { event=ReturnPressed; target=chat_osrc; action=Refresh; }
        }
        
    send_button "widget/imagebutton"
        {
        x=370; y=260; height=20; width=20;
        image="/apps/kardia/images/icons/chat_send.png";
        
        send_cn_1 "widget/connector" { target=chat_timer; event=Click; action=CancelTimer;}
        
        // Connector for the actual event - Same as enter_cn_3 of type_eb
        send_cn_2 "widget/connector"
            {
            target=new_message_osrc;
            action="Create";
            event="Click";
            
            // Parameters
            c_chat_id=runclient(:newchat_panel:chat_id);
            c_message=runclient(rtrim(ltrim(:type_eb:content)));
            s_date_created=runclient(getdate());
            s_created_by=runclient(user_name());
            s_date_modified=runclient(getdate());
            s_modified_by=runclient(user_name());
            }
            
        send_cn_3 "widget/connector" { target=type_eb; event=Click; action=SetValue; Value=runclient('');}
        send_cn_4 "widget/connector" { event=Click; target=chat_osrc; action=Refresh; }
        }
    
    } // End chat_id